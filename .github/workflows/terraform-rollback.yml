name: Terraform Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - prod
      commit_sha:
        description: 'Git commit SHA to rollback to (leave empty for previous commit)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  issues: write

env:
  TF_VERSION: '1.13.5'
  AWS_REGION: 'eu-west-1'

jobs:
  rollback-validation:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      target_sha: ${{ steps.determine_target.outputs.sha }}
      target_short_sha: ${{ steps.determine_target.outputs.short_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target commit
        id: determine_target
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            TARGET_SHA="${{ github.event.inputs.commit_sha }}"
          else
            # Get the previous commit
            TARGET_SHA=$(git log --skip=1 -n 1 --format="%H")
          fi

          SHORT_SHA=$(echo $TARGET_SHA | cut -c1-7)

          echo "sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "### Rollback Target" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$SHORT_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "**Full SHA:** \`$TARGET_SHA\`" >> $GITHUB_STEP_SUMMARY

      - name: Validate commit exists
        run: |
          if ! git cat-file -e ${{ steps.determine_target.outputs.sha }}; then
            echo "âŒ Commit ${{ steps.determine_target.outputs.sha }} does not exist"
            exit 1
          fi

          echo "âœ… Commit validated" >> $GITHUB_STEP_SUMMARY

  rollback-plan:
    name: Plan Rollback
    runs-on: ubuntu-latest
    needs: rollback-validation
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.rollback-validation.outputs.target_sha }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform/environments/${{ github.event.inputs.environment }}
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform/environments/${{ github.event.inputs.environment }}
          terraform plan -no-color -out=rollback.tfplan | tee plan_output.txt

      - name: Upload Rollback Plan
        uses: actions/upload-artifact@v4
        with:
          name: rollback-plan
          path: |
            terraform/environments/${{ github.event.inputs.environment }}/rollback.tfplan
            terraform/environments/${{ github.event.inputs.environment }}/plan_output.txt
          retention-days: 5

      - name: Plan Summary
        run: |
          echo "### Rollback Plan" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Commit:** ${{ needs.rollback-validation.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the plan above and approve the rollback to proceed." >> $GITHUB_STEP_SUMMARY

  rollback-apply:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [rollback-validation, rollback-plan]
    environment:
      name: production
      url: https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.rollback-validation.outputs.target_sha }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform/environments/${{ github.event.inputs.environment }}
          terraform init

      - name: Download Rollback Plan
        uses: actions/download-artifact@v4
        with:
          name: rollback-plan
          path: terraform/environments/${{ github.event.inputs.environment }}

      - name: Execute Rollback
        id: apply
        run: |
          cd terraform/environments/${{ github.event.inputs.environment }}
          terraform apply rollback.tfplan

      - name: Create Rollback Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = `## Rollback Executed

            **Environment:** \`${{ github.event.inputs.environment }}\`
            **Rolled back to:** \`${{ needs.rollback-validation.outputs.short_sha }}\`
            **Executed at:** ${new Date().toISOString()}
            **Executed by:** @${{ github.actor }}
            **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Reason
            ${{ github.event.inputs.reason }}

            ### Actions Taken
            - âœ… Validated target commit
            - âœ… Generated rollback plan
            - âœ… Applied rollback to infrastructure

            ### Follow-up Actions Required
            - [ ] Verify infrastructure is working correctly
            - [ ] Update main branch if needed
            - [ ] Document root cause of the issue that required rollback
            - [ ] Implement fix and re-deploy

            ---
            *This issue was automatically created by the rollback workflow*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Rollback executed: ${{ github.event.inputs.environment }} to ${{ needs.rollback-validation.outputs.short_sha }}`,
              body: issueBody,
              labels: ['rollback', '${{ github.event.inputs.environment }}', 'infrastructure']
            });

      - name: Summary
        run: |
          echo "âœ… Rollback completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ needs.rollback-validation.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify infrastructure health" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate root cause" >> $GITHUB_STEP_SUMMARY
          echo "3. Implement and test fix" >> $GITHUB_STEP_SUMMARY
          echo "4. Deploy fix via normal workflow" >> $GITHUB_STEP_SUMMARY

  rollback-notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [rollback-validation, rollback-apply]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.rollback-apply.result }}" == "success" ]; then
            echo "message=âœ… Rollback completed successfully" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "message=âŒ Rollback failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ needs.rollback-validation.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
