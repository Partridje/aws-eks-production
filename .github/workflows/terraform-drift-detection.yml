name: Terraform Drift Detection

on:
  schedule:
    # Run daily at 9:00 AM UTC (12:00 PM Moscow time)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read
  issues: write

env:
  TF_VERSION: '1.13.5'
  AWS_REGION: 'eu-west-1'

jobs:
  drift-detection:
    name: Detect Configuration Drift
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["dev", "prod"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform/environments/${{ matrix.environment }}
          terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          cd terraform/environments/${{ matrix.environment }}
          terraform plan -detailed-exitcode -no-color -out=drift.tfplan > plan_output.txt 2>&1 || echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          cd terraform/environments/${{ matrix.environment }}
          EXIT_CODE="${{ steps.plan.outputs.exitcode }}"

          if [ -z "$EXIT_CODE" ]; then
            # No drift detected
            echo "has_drift=false" >> $GITHUB_OUTPUT
            echo "status=✅ No drift detected" >> $GITHUB_OUTPUT
          elif [ "$EXIT_CODE" == "2" ]; then
            # Drift detected
            echo "has_drift=true" >> $GITHUB_OUTPUT
            echo "status=⚠️ Configuration drift detected" >> $GITHUB_OUTPUT
          else
            # Error occurred
            echo "has_drift=error" >> $GITHUB_OUTPUT
            echo "status=❌ Error during drift detection" >> $GITHUB_OUTPUT
          fi

      - name: Save Plan Output
        if: steps.drift.outputs.has_drift == 'true' || steps.drift.outputs.has_drift == 'error'
        run: |
          cd terraform/environments/${{ matrix.environment }}
          if [ -f plan_output.txt ]; then
            cat plan_output.txt
          fi

      - name: Create Issue for Drift
        if: steps.drift.outputs.has_drift == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/environments/${{ matrix.environment }}/plan_output.txt', 'utf8');

            const issueTitle = `⚠️ Terraform Drift Detected in ${{ matrix.environment }} environment`;
            const issueBody = `## Configuration Drift Detected

            **Environment:** \`${{ matrix.environment }}\`
            **Detected at:** ${new Date().toISOString()}
            **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### What is drift?
            Drift occurs when the actual infrastructure state differs from what's defined in Terraform code. This can happen due to:
            - Manual changes via AWS Console
            - Changes made by other tools or scripts
            - Automatic updates by AWS services

            ### Detected Changes

            <details>
            <summary>Click to view full plan output</summary>

            \`\`\`hcl
            ${planOutput.slice(0, 60000)}
            \`\`\`

            </details>

            ### Recommended Actions

            1. **Review the changes** to understand what drifted
            2. **Investigate the cause** (who/what made the change?)
            3. **Choose resolution:**
               - Update Terraform code to match current state (if change was intentional)
               - Run \`terraform apply\` to revert infrastructure to Terraform state
               - Document the change and close this issue

            ### How to fix

            \`\`\`bash
            # Review the drift
            cd terraform/environments/${{ matrix.environment }}
            terraform plan

            # Option 1: Apply Terraform to fix drift
            terraform apply

            # Option 2: Import manual changes to Terraform state
            terraform import <resource> <id>
            \`\`\`

            ---
            *This issue was automatically created by the drift detection workflow*
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['terraform-drift', '${{ matrix.environment }}']
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['terraform-drift', '${{ matrix.environment }}', 'infrastructure']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## New drift detected at ${new Date().toISOString()}\n\n${issueBody}`
              });
            }

      - name: Summary
        run: |
          echo "${{ steps.drift.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Checked at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.drift.outputs.has_drift }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Action Required:** Review and resolve the configuration drift" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub issue has been created with details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if error
        if: steps.drift.outputs.has_drift == 'error'
        run: exit 1
